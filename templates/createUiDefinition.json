{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "resourceGroup",
        "type": "Microsoft.Common.Section",
        "label": "Resource Group",
        "elements": [],
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "networkConfig",
        "label": "Network Configuration",
        "elements": [
          {
            "name": "localVnetSection",
            "type": "Microsoft.Common.Section",
            "label": "Local Virtual Network",
            "elements": [
              {
                "name": "localVnetName",
                "type": "Microsoft.Common.TextBox",
                "label": "Local VNet Name",
                "toolTip": "Name of the VNet in this tenant that will be peered",
                "placeholder": "vnet-prod-eastus",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9][a-zA-Z0-9-_]{0,62}[a-zA-Z0-9]$",
                  "validationMessage": "VNet name must be 1-64 characters, alphanumeric, hyphens, and underscores"
                },
                "visible": true
              },
              {
                "name": "localVnetInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "This is the VNet in YOUR tenant that you want to peer with the remote VNet."
                }
              }
            ],
            "visible": true
          },
          {
            "name": "remoteVnetSection",
            "type": "Microsoft.Common.Section",
            "label": "Remote Virtual Network (Other Tenant)",
            "elements": [
              {
                "name": "remoteVnetResourceId",
                "type": "Microsoft.Common.TextBox",
                "label": "Remote VNet Resource ID",
                "toolTip": "Full resource ID of the VNet in the other tenant",
                "placeholder": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/rg-name/providers/Microsoft.Network/virtualNetworks/vnet-name",
                "multiLine": false,
                "constraints": {
                  "required": true,
                  "regex": "^/subscriptions/[a-fA-F0-9-]{36}/resourceGroups/[^/]+/providers/Microsoft\\.Network/virtualNetworks/[^/]+$",
                  "validationMessage": "Must be a valid VNet resource ID: /subscriptions/{sub-id}/resourceGroups/{rg}/providers/Microsoft.Network/virtualNetworks/{vnet-name}"
                },
                "visible": true
              },
              {
                "name": "remoteVnetInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Warning",
                  "text": "Get this Resource ID from the other tenant's administrator. You can find it by navigating to the VNet in Azure Portal → Properties → Resource ID"
                }
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "peeringConfig",
        "label": "Peering Configuration",
        "elements": [
          {
            "name": "peeringName",
            "type": "Microsoft.Common.TextBox",
            "label": "Peering Name",
            "defaultValue": "peer-to-remote-vnet",
            "toolTip": "Name for this peering connection",
            "placeholder": "peer-prod-to-partner",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z0-9][a-zA-Z0-9-_]{0,78}[a-zA-Z0-9]$",
              "validationMessage": "Peering name must be 1-80 characters, alphanumeric, hyphens, and underscores"
            },
            "visible": true
          },
          {
            "name": "allowVnetAccess",
            "type": "Microsoft.Common.CheckBox",
            "label": "Allow Virtual Network Access",
            "toolTip": "Allow resources in the peered VNets to communicate",
            "defaultValue": true,
            "constraints": {
              "required": false
            }
          },
          {
            "name": "advancedOptions",
            "type": "Microsoft.Common.Section",
            "label": "Advanced Options",
            "elements": [
              {
                "name": "allowForwardedTraffic",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow Forwarded Traffic",
                "toolTip": "Allow traffic forwarded by a Network Virtual Appliance (NVA) in the remote VNet",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "gatewayTransitInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Gateway transit allows one VNet to use the VPN gateway in the peered VNet. Only enable if you have a VPN Gateway configured."
                }
              },
              {
                "name": "allowGatewayTransit",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow Gateway Transit",
                "toolTip": "This VNet has a VPN gateway and allows the remote VNet to use it",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "useRemoteGateways",
                "type": "Microsoft.Common.CheckBox",
                "label": "Use Remote Gateways",
                "toolTip": "Use the VPN gateway in the remote VNet (remote VNet must have 'Allow Gateway Transit' enabled)",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "gatewayWarning",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[or(steps('peeringConfig').advancedOptions.allowGatewayTransit, steps('peeringConfig').advancedOptions.useRemoteGateways)]",
                "options": {
                  "icon": "Warning",
                  "text": "Note: 'Allow Gateway Transit' and 'Use Remote Gateways' cannot both be enabled on the same peering. Ensure only one is checked."
                }
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "validation",
        "label": "Validation",
        "elements": [
          {
            "name": "validationInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Azure will validate the deployment before creating resources. This includes checking permissions, resource existence, and address space overlap."
            }
          },
          {
            "name": "validationChecklist",
            "type": "Microsoft.Common.Section",
            "label": "Pre-deployment Checklist",
            "elements": [
              {
                "name": "checklistText",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Before deploying, ensure:\n\n✓ You have the 'vnet-peer' custom RBAC role assigned\n✓ The local VNet exists in this resource group\n✓ You have the correct Remote VNet Resource ID\n✓ VNet address spaces do not overlap\n✓ The remote tenant will also create their side of the peering\n\nNote: The peering will show 'Initiated' until the remote tenant creates their side. Once both sides exist, it will show 'Connected'."
                }
              }
            ],
            "visible": true
          }
        ]
      }
    ],
    "outputs": {
      "localVnetName": "[steps('networkConfig').localVnetSection.localVnetName]",
      "remoteVnetResourceId": "[steps('networkConfig').remoteVnetSection.remoteVnetResourceId]",
      "peeringName": "[steps('peeringConfig').peeringName]",
      "allowVnetAccess": "[steps('peeringConfig').allowVnetAccess]",
      "allowForwardedTraffic": "[steps('peeringConfig').advancedOptions.allowForwardedTraffic]",
      "allowGatewayTransit": "[steps('peeringConfig').advancedOptions.allowGatewayTransit]",
      "useRemoteGateways": "[steps('peeringConfig').advancedOptions.useRemoteGateways]"
    }
  }
}
