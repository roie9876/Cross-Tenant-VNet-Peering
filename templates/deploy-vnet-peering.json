{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "12652728096032345107"
    }
  },
  "parameters": {
    "localVnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the local VNet that will be peered"
      }
    },
    "remoteVnetResourceId": {
      "type": "string",
      "metadata": {
        "description": "Full resource ID of the remote VNet in the other tenant. Format: /subscriptions/{sub-id}/resourceGroups/{rg-name}/providers/Microsoft.Network/virtualNetworks/{vnet-name}"
      }
    },
    "peeringName": {
      "type": "string",
      "metadata": {
        "description": "Name for this peering connection"
      }
    },
    "allowVnetAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow virtual network access between the VNets"
      }
    },
    "allowForwardedTraffic": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow forwarded traffic from the remote VNet"
      }
    },
    "allowGatewayTransit": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow gateway transit (this VNet has a VPN gateway)"
      }
    },
    "useRemoteGateways": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use remote VNet gateway (remote VNet has a VPN gateway)"
      }
    }
  },
  "variables": {
    "remoteVnetIdParts": "[split(parameters('remoteVnetResourceId'), '/')]",
    "isValidRemoteVnetId": "[and(and(equals(length(variables('remoteVnetIdParts')), 9), equals(variables('remoteVnetIdParts')[6], 'Microsoft.Network')), equals(variables('remoteVnetIdParts')[7], 'virtualNetworks'))]",
    "remoteSubscriptionId": "[if(variables('isValidRemoteVnetId'), variables('remoteVnetIdParts')[2], 'invalid')]",
    "remoteVnetName": "[if(variables('isValidRemoteVnetId'), variables('remoteVnetIdParts')[8], 'invalid')]",
    "gatewayTransitValid": "[not(and(parameters('allowGatewayTransit'), parameters('useRemoteGateways')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', parameters('localVnetName'), parameters('peeringName'))]",
      "properties": {
        "allowVirtualNetworkAccess": "[parameters('allowVnetAccess')]",
        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
        "useRemoteGateways": "[parameters('useRemoteGateways')]",
        "remoteVirtualNetwork": {
          "id": "[parameters('remoteVnetResourceId')]"
        }
      }
    }
  ],
  "outputs": {
    "peeringName": {
      "type": "string",
      "metadata": {
        "description": "Name of the created peering"
      },
      "value": "[parameters('peeringName')]"
    },
    "peeringState": {
      "type": "string",
      "metadata": {
        "description": "Peering state"
      },
      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', parameters('localVnetName'), parameters('peeringName')), '2023-09-01').peeringState]"
    },
    "peeringSyncLevel": {
      "type": "string",
      "metadata": {
        "description": "Peering sync level"
      },
      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', parameters('localVnetName'), parameters('peeringName')), '2023-09-01').peeringSyncLevel]"
    },
    "provisioningState": {
      "type": "string",
      "metadata": {
        "description": "Provisioning state"
      },
      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', parameters('localVnetName'), parameters('peeringName')), '2023-09-01').provisioningState]"
    },
    "localVnetAddressSpace": {
      "type": "array",
      "metadata": {
        "description": "Local VNet address space"
      },
      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('localVnetName')), '2023-09-01').addressSpace.addressPrefixes]"
    },
    "remoteVnetId": {
      "type": "string",
      "metadata": {
        "description": "Remote VNet resource ID"
      },
      "value": "[parameters('remoteVnetResourceId')]"
    },
    "peeringConfig": {
      "type": "object",
      "metadata": {
        "description": "Peering configuration summary"
      },
      "value": {
        "localVnet": "[parameters('localVnetName')]",
        "remoteVnet": "[variables('remoteVnetName')]",
        "remoteSubscription": "[variables('remoteSubscriptionId')]",
        "allowVnetAccess": "[parameters('allowVnetAccess')]",
        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
        "useRemoteGateways": "[parameters('useRemoteGateways')]"
      }
    },
    "validationRemoteVnetId": {
      "type": "bool",
      "metadata": {
        "description": "Validation: Remote VNet ID format is valid"
      },
      "value": "[variables('isValidRemoteVnetId')]"
    },
    "validationGatewayTransit": {
      "type": "bool",
      "metadata": {
        "description": "Validation: Gateway transit settings are valid"
      },
      "value": "[variables('gatewayTransitValid')]"
    }
  }
}